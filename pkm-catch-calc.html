<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pok√©Catch: Master Class</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --primary: #FF5350;
      --accent: #3b4cca;
      --text-dark: #2c3e50;
      --text-gray: #7f8c8d;
      --hp-green: #4bc05b;
      --hp-yellow: #f5ac0f;
      --hp-red: #ff5040;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Kanit', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: var(--card-bg);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      position: relative;
      overflow: visible !important; 
      backdrop-filter: blur(10px);
    }

    header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 1.8em; color: var(--accent); font-weight: 700; margin-bottom: 5px;}
    p.subtitle { font-size: 0.9em; color: var(--text-gray); }

    /* Display Area */
    .poke-display {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; min-height: 150px;
      position: relative; z-index: 100;
    }
    .poke-img-wrapper {
      width: 110px; height: 110px; background: rgba(0,0,0,0.05);
      border-radius: 50%; display: flex; justify-content: center; align-items: center;
      margin-bottom: 10px; position: relative;
    }
    .poke-img { width: 100%; height: 100%; object-fit: contain; z-index: 2; transition: 0.3s;}
    
    .info-badges { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; justify-content: center; }
    .badge { font-size: 0.7em; padding: 2px 8px; border-radius: 10px; color: white; background: #999; text-transform: uppercase; font-weight: 600;}

    /* Search Box */
    .search-wrapper {
      width: 100%; position: relative; z-index: 9999; display: flex; align-items: center; margin-top: 10px;
    }
    .search-input {
      width: 100%; padding: 10px 40px 10px 15px; border-radius: 12px; border: 2px solid #eee;
      font-family: 'Kanit'; font-size: 1em; background: #f9f9f9; transition: 0.3s;
    }
    .search-input:focus { outline: none; border-color: var(--accent); background: white; }
    .dropdown-arrow {
      position: absolute; right: 10px; width: 30px; height: 30px;
      display: flex; justify-content: center; align-items: center; cursor: pointer; color: #999;
      transition: 0.2s; border-radius: 50%;
    }
    .dropdown-arrow:hover { background: #eee; color: var(--accent); }
    .dropdown-arrow svg { width: 16px; height: 16px; fill: currentColor; }

    .suggestions-list {
      position: absolute; top: 105%; left: 0; width: 100%; background: white;
      border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-height: 300px; overflow-y: auto; list-style: none; display: none;
      z-index: 10000; border: 1px solid #eee;
    }
    .suggestions-list.active { display: block; }
    .suggestions-list li {
      padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f5f5f5;
      color: #333; text-transform: capitalize; transition: background 0.1s; display: flex; align-items: center;
    }
    .suggestions-list li:hover { background: #f0f4ff; color: var(--accent); font-weight: 600; }

    /* --- Tab System --- */
    .tabs-nav {
      display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;
      scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .tabs-nav::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */
    
    .tab-btn {
      padding: 8px 16px; border-radius: 20px; border: none; background: #eee;
      color: #777; font-weight: 600; font-family: 'Kanit'; cursor: pointer; transition: 0.3s; white-space: nowrap; font-size: 0.9em;
    }
    .tab-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(59, 76, 202, 0.3); }

    /* Grid Options */
    .grid-options-balls { display: none; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .grid-options-balls.active { display: grid; }
    
    .radio-card input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
    .card-content {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 5px; border: 2px solid #eee; border-radius: 10px; transition: 0.2s; height: 75px;
      position: relative;
    }
    .radio-card input:checked + .card-content {
      border-color: var(--accent); background: rgba(59, 76, 202, 0.05); color: var(--accent); font-weight: 600;
    }
    .ball-icon { width: 30px; height: 30px; object-fit: contain; margin-bottom: 4px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }

    /* --- Context Panel (Dynamic) --- */
    .context-panel {
      background: #f0f4f8; padding: 15px; border-radius: 16px; margin-bottom: 20px;
      display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: center;
      border: 1px solid #e1e8ed; min-height: 60px;
    }
    .context-panel.hidden { display: none; }
    .context-msg { color: #666; font-size: 0.9em; font-style: italic; }
    
    .input-group { display: flex; align-items: center; gap: 8px; font-size: 0.9em; font-weight: 600; color: #555; }
    .tiny-input { width: 50px; padding: 5px; border-radius: 6px; border: 1px solid #ccc; text-align: center; font-weight: bold; }
    
    /* Toggle Switch */
    .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* HP Slider */
    .hp-container { position: relative; height: 20px; background: #eee; border-radius: 15px; overflow: hidden; margin-top: 5px;}
    .hp-fill { height: 100%; width: 100%; background: var(--hp-green); transition: 0.3s; border-radius: 15px 0 0 15px; }
    input[type=range] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

    /* Result */
    .result-box {
      background: #f8f9fa; border-radius: 20px; padding: 15px; text-align: center; margin-top: 20px;
      position: relative; z-index: 1;
    }
    .percentage { font-size: 2.5em; font-weight: 700; color: var(--accent); line-height: 1; margin-bottom: 5px; }
    .percentage span { font-size: 0.4em; color: var(--text-gray); }
    
    .sim-btn {
      background: var(--primary); color: white; border: none; padding: 12px;
      width: 100%; border-radius: 12px; font-size: 1.1em; font-weight: 600;
      font-family: 'Kanit'; cursor: pointer; transition: 0.2s;
      box-shadow: 0 5px 15px rgba(255, 83, 80, 0.3); margin-top: 10px;
    }
    .sim-btn:hover { background: #ff3330; transform: translateY(-2px); }
    .sim-btn:disabled { background: #ccc; cursor: not-allowed; }

    /* Status Grid */
    .grid-options-status { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px;}
    .status-icon-group { display: flex; justify-content: center; gap: 2px; }
    .status-icon { width: 18px; height: 18px; object-fit: contain; }

    /* Overlay */
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.98); display: flex; justify-content: center;
      align-items: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #overlay.active { opacity: 1; pointer-events: all; }
    .pokeball-anim-img { width: 80px; height: 80px; object-fit: contain; animation: shake 1s infinite; }
    @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 50% { transform: rotate(-20deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
    .loading-spinner { position: absolute; width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Pok√©Catch Master</h1>
    <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£ (Full Mechanics)</p>
  </header>

  <div class="poke-display">
    <div class="poke-img-wrapper">
      <div class="loading-spinner" id="spinner"></div>
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png" alt="Pokemon" class="poke-img" id="poke-img">
    </div>
    <div class="info-badges" id="info-badges">
      <span class="badge" style="background:#F7D02C; color:#333;">Electric</span>
    </div>
    
    <div class="search-wrapper">
      <input type="text" id="poke-search" class="search-input" placeholder="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." disabled autocomplete="off">
      <div class="dropdown-arrow" id="toggle-arrow">
        <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
      </div>
      <ul id="suggestions" class="suggestions-list"></ul>
    </div>
    <div style="text-align:center; font-size:0.8em; color:#999; margin-top:2px;">
      Rate: <span id="cr-display">190</span> | Weight: <span id="weight-display">6.0</span>kg
    </div>
  </div>

  <div id="context-panel" class="context-panel">
    <span class="context-msg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ö‡∏≠‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
    </div>

  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab('basic')">‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</button>
    <button class="tab-btn" onclick="switchTab('tech')">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</button>
    <button class="tab-btn" onclick="switchTab('special')">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á</button>
    <button class="tab-btn" onclick="switchTab('cosmetic')">‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°</button>
  </div>

  <div class="control-group">
    
    <div id="grid-basic" class="grid-options-balls active">
      <label class="radio-card"><input type="radio" name="ball" value="poke" checked data-img="poke-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="ball-icon"><div style="font-size:0.7em">Pok√©</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="great" data-img="great-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png" class="ball-icon"><div style="font-size:0.7em">Great</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="ultra" data-img="ultra-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png" class="ball-icon"><div style="font-size:0.7em">Ultra</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="master" data-img="master-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="ball-icon"><div style="font-size:0.7em; color:purple">Master</div></div></label>
    </div>

    <div id="grid-tech" class="grid-options-balls">
      <label class="radio-card"><input type="radio" name="ball" value="quick" data-img="quick-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/quick-ball.png" class="ball-icon"><div style="font-size:0.7em">Quick</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="dusk" data-img="dusk-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/dusk-ball.png" class="ball-icon"><div style="font-size:0.7em">Dusk</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="timer" data-img="timer-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/timer-ball.png" class="ball-icon"><div style="font-size:0.7em">Timer</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="net" data-img="net-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/net-ball.png" class="ball-icon"><div style="font-size:0.7em">Net</div></div></label>
    </div>

    <div id="grid-special" class="grid-options-balls">
      <label class="radio-card"><input type="radio" name="ball" value="heavy" data-img="heavy-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/heavy-ball.png" class="ball-icon"><div style="font-size:0.7em">Heavy</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="level" data-img="level-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/level-ball.png" class="ball-icon"><div style="font-size:0.7em">Level</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="love" data-img="love-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/love-ball.png" class="ball-icon"><div style="font-size:0.7em">Love</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="fast" data-img="fast-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/fast-ball.png" class="ball-icon"><div style="font-size:0.7em">Fast</div></div></label>
    </div>

    <div id="grid-cosmetic" class="grid-options-balls">
      <label class="radio-card"><input type="radio" name="ball" value="luxury" data-img="luxury-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/luxury-ball.png" class="ball-icon"><div style="font-size:0.7em">Luxury</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="premier" data-img="premier-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/premier-ball.png" class="ball-icon"><div style="font-size:0.7em">Premier</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="heal" data-img="heal-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/heal-ball.png" class="ball-icon"><div style="font-size:0.7em">Heal</div></div></label>
      <label class="radio-card"><input type="radio" name="ball" value="nest" data-img="nest-ball"><div class="card-content"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/nest-ball.png" class="ball-icon"><div style="font-size:0.7em">Nest</div></div></label>
    </div>
  </div>

  <div style="margin-top:20px;">
    <div class="section-title">
      <span>HP Remaining</span>
      <span id="hp-val" style="color:var(--hp-green)">100%</span>
    </div>
    <div class="hp-container">
      <div id="hp-fill" class="hp-fill"></div>
      <input type="range" id="hp-slider" min="1" max="100" value="100">
    </div>

    <div class="section-title" style="margin-top:15px;"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span></div>
    <div class="grid-options-status">
      <label class="radio-card">
        <input type="radio" name="status" value="1" checked>
        <div class="card-content" style="height:50px">
          <div style="font-size:1em">‚ö™</div>
          <div style="font-size:0.7em">Normal</div>
        </div>
      </label>
      <label class="radio-card">
        <input type="radio" name="status" value="1.5">
        <div class="card-content" style="height:50px">
          <div class="status-icon-group">
             <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/burn-heal.png" class="status-icon">
             <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/antidote.png" class="status-icon">
             <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/paralyze-heal.png" class="status-icon">
          </div>
          <div style="font-size:0.7em">x1.5</div>
        </div>
      </label>
      <label class="radio-card">
        <input type="radio" name="status" value="2.5">
        <div class="card-content" style="height:50px">
           <div class="status-icon-group">
              <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/awakening.png" class="status-icon">
              <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ice-heal.png" class="status-icon">
          </div>
          <div style="font-size:0.7em">x2.5</div>
        </div>
      </label>
    </div>
  </div>

  <div class="result-box">
    <div class="percentage" id="result-percent">0<span>%</span></div>
    <button class="sim-btn" id="btn-throw">üéÆ ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏õ‡∏≤‡∏ö‡∏≠‡∏• (Simulate)</button>
  </div>

  <div id="overlay"><div id="anim-content" style="text-align: center;"></div></div>

</div>

<script>
// --- GLOBAL VARS ---
let currentBaseRate = 190; 
let currentWeight = 6.0; // kg
let currentSpeed = 50; // Base speed for Fast Ball
let currentTypes = ['electric'];
let allPokemonNames = [];
let currentBall = 'poke';

// DOM Elements
const searchInput = document.getElementById('poke-search');
const suggestionsList = document.getElementById('suggestions');
const imgEl = document.getElementById('poke-img');
const infoBadgesEl = document.getElementById('info-badges');
const crDisplay = document.getElementById('cr-display');
const weightDisplay = document.getElementById('weight-display');
const hpSlider = document.getElementById('hp-slider');
const hpFill = document.getElementById('hp-fill');
const hpVal = document.getElementById('hp-val');
const resultEl = document.getElementById('result-percent');
const btnThrow = document.getElementById('btn-throw');
const contextPanel = document.getElementById('context-panel');
const spinner = document.getElementById('spinner');

const typeColors = {
  normal: '#A8A77A', fire: '#EE8130', water: '#6390F0', electric: '#F7D02C',
  grass: '#7AC74C', ice: '#96D9D6', fighting: '#C22E28', poison: '#A33EA1',
  ground: '#E2BF65', flying: '#A98FF3', psychic: '#F95587', bug: '#A6B91A',
  rock: '#B6A136', ghost: '#735797', dragon: '#6F35FC', dark: '#705746',
  steel: '#B7B7CE', fairy: '#D685AD'
};

// --- INIT ---
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('https://pokeapi.co/api/v2/pokemon-species?limit=1025');
    const data = await res.json();
    allPokemonNames = data.results.map(p => p.name);
    searchInput.disabled = false;
    searchInput.placeholder = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡πÄ‡∏Å‡∏°‡∏≠‡∏ô...";
    updateContextPanel('poke'); // Init context
    calculate();
  } catch (e) { console.error(e); }
});

// --- TABS LOGIC ---
window.switchTab = function(tabName) {
  // Hide all grids
  document.querySelectorAll('.grid-options-balls').forEach(el => el.classList.remove('active'));
  // Show selected grid
  document.getElementById(`grid-${tabName}`).classList.add('active');
  
  // Update buttons state
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}

// --- API LOGIC ---
async function fetchPokemonData(name) {
  if (!name) return;
  name = name.toLowerCase();
  spinner.style.display = 'block'; imgEl.style.opacity = '0.5';

  try {
    const speciesRes = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${name}`);
    if(!speciesRes.ok) throw new Error('Not found');
    const speciesData = await speciesRes.json();
    
    const pokeRes = await fetch(`https://pokeapi.co/api/v2/pokemon/${speciesData.id}`);
    const pokeData = await pokeRes.json();

    currentBaseRate = speciesData.capture_rate;
    currentWeight = pokeData.weight / 10; // API returns hectograms
    currentTypes = pokeData.types.map(t => t.type.name);
    currentSpeed = pokeData.stats.find(s => s.stat.name === 'speed').base_stat;

    // UI Updates
    imgEl.src = pokeData.sprites.other['official-artwork'].front_default || pokeData.sprites.front_default;
    crDisplay.textContent = currentBaseRate;
    weightDisplay.textContent = currentWeight;
    searchInput.value = name.charAt(0).toUpperCase() + name.slice(1);

    infoBadgesEl.innerHTML = '';
    currentTypes.forEach(t => {
      const badge = document.createElement('span');
      badge.className = 'badge'; badge.textContent = t;
      badge.style.backgroundColor = typeColors[t] || '#777';
      infoBadgesEl.appendChild(badge);
    });

    calculate();
  } catch (e) { console.error(e); } 
  finally { spinner.style.display = 'none'; imgEl.style.opacity = '1'; }
}

// --- CONTEXT PANEL MANAGER ---
function updateContextPanel(ballType) {
  contextPanel.innerHTML = ''; // Clear

  if (ballType === 'quick') {
    contextPanel.innerHTML = `
      <div class="input-group">
        <label>‚ö° Turn 1?</label>
        <label class="toggle-switch"><input type="checkbox" id="is-turn-one" onchange="calculate()"><span class="slider"></span></label>
      </div>`;
  } 
  else if (ballType === 'timer') {
    contextPanel.innerHTML = `
      <div class="input-group">
        <label>‚åö Turns passed:</label>
        <input type="number" id="turn-count" class="tiny-input" value="1" min="1" max="50" oninput="calculate()">
      </div>`;
  }
  else if (ballType === 'dusk') {
    contextPanel.innerHTML = `
      <div class="input-group">
        <label>üåë Night/Cave?</label>
        <label class="toggle-switch"><input type="checkbox" id="is-dark" onchange="calculate()"><span class="slider"></span></label>
      </div>`;
  }
  else if (ballType === 'level') {
    contextPanel.innerHTML = `
      <div class="input-group"><label>My Lv:</label><input type="number" id="my-lvl" class="tiny-input" value="50" oninput="calculate()"></div>
      <div class="input-group"><label>Enemy Lv:</label><input type="number" id="enemy-lvl" class="tiny-input" value="50" oninput="calculate()"></div>`;
  }
  else if (ballType === 'love') {
     contextPanel.innerHTML = `
      <div class="input-group">
        <label>‚ù§Ô∏è Opposite Gender & Same Species?</label>
        <label class="toggle-switch"><input type="checkbox" id="is-love" onchange="calculate()"><span class="slider"></span></label>
      </div>`;
  }
  else if (ballType === 'heavy') {
    contextPanel.innerHTML = `<span class="context-msg">‚öñÔ∏è ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (Target: ${currentWeight}kg)</span>`;
  }
  else if (ballType === 'fast') {
     contextPanel.innerHTML = `<span class="context-msg">üí® ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Speed: ${currentSpeed})</span>`;
  }
  else if (ballType === 'net') {
    if(currentTypes.includes('water') || currentTypes.includes('bug'))
      contextPanel.innerHTML = `<span class="context-msg" style="color:var(--hp-green)">‚úÖ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô Water/Bug (x3.5)</span>`;
    else
      contextPanel.innerHTML = `<span class="context-msg">‚ùå ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Water/Bug (x1)</span>`;
  }
  else {
    contextPanel.innerHTML = `<span class="context-msg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>`;
  }
}

// --- CALCULATION LOGIC ---
function calculate() {
  const hp = parseInt(hpSlider.value);
  const ballRadio = document.querySelector('input[name="ball"]:checked');
  const statusEl = document.querySelector('input[name="status"]:checked');
  if (!ballRadio || !statusEl) return;

  currentBall = ballRadio.value;
  const statusMult = parseFloat(statusEl.value);

  // Update HP UI
  hpFill.style.width = hp + '%'; hpVal.textContent = hp + '%';
  if(hp < 20) { hpFill.style.background = 'var(--hp-red)'; hpVal.style.color = 'var(--hp-red)'; }
  else if(hp < 50) { hpFill.style.background = 'var(--hp-yellow)'; hpVal.style.color = 'var(--hp-yellow)'; }
  else { hpFill.style.background = 'var(--hp-green)'; hpVal.style.color = 'var(--hp-green)'; }

  // Master Ball Check
  if (currentBall === 'master') { resultEl.innerHTML = '100<span>%</span>'; return; }

  // 1. Calculate Ball Multiplier (or Modified Rate for Heavy)
  let ballMult = 1;
  let heavyMod = 0; // Additive modifier for Heavy Ball

  // --- LOGIC ZONE ---
  const getEl = (id) => document.getElementById(id);

  switch(currentBall) {
    case 'great': ballMult = 1.5; break;
    case 'ultra': ballMult = 2; break;
    case 'quick': if(getEl('is-turn-one')?.checked) ballMult = 5; break;
    case 'dusk': if(getEl('is-dark')?.checked) ballMult = 3; break;
    case 'timer': 
      let t = parseInt(getEl('turn-count')?.value) || 1;
      ballMult = Math.min(4, 1 + (t * 0.3)); 
      break;
    case 'net': 
      if(currentTypes.includes('water') || currentTypes.includes('bug')) ballMult = 3.5;
      break;
    case 'level':
      let myLv = parseInt(getEl('my-lvl')?.value) || 50;
      let enLv = parseInt(getEl('enemy-lvl')?.value) || 50;
      if (myLv <= enLv) ballMult = 1;
      else if (myLv > enLv * 4) ballMult = 8;
      else if (myLv > enLv * 2) ballMult = 4;
      else ballMult = 2;
      break;
    case 'love': if(getEl('is-love')?.checked) ballMult = 8; break;
    case 'fast': if(currentSpeed >= 100) ballMult = 4; break;
    case 'heavy':
      // Heavy ball uses Additive logic, not Multiplicative (Gen 7 formula)
      if (currentWeight < 100) heavyMod = -20;
      else if (currentWeight < 200) heavyMod = 0;
      else if (currentWeight < 300) heavyMod = 20;
      else heavyMod = 30;
      break;
    // Cosmetic balls (Luxury, Premier, etc) = 1
  }

  // 2. Final Formula
  const maxHP = 100;
  const curHP = hp;
  
  // Base calculation term
  let catchValue = 0;

  if (currentBall === 'heavy') {
    // Special Formula for Heavy Ball: (Rate + Modifier)
    let modifiedRate = currentBaseRate + heavyMod;
    if (modifiedRate < 1) modifiedRate = 1; // Minimum 1
    // Apply standard HP/Status logic to modified rate
    catchValue = ((3 * maxHP - 2 * curHP) * modifiedRate * 1) / (3 * maxHP) * statusMult;
  } else {
    // Standard Formula
    catchValue = ((3 * maxHP - 2 * curHP) * currentBaseRate * ballMult) / (3 * maxHP) * statusMultiplier(statusMult);
  }

  // Convert to %
  let prob = (catchValue / 255) * 100;
  if(prob > 100) prob = 100;
  if(prob < 0) prob = 0;

  window.currentProbability = prob; // Global for sim
  resultEl.innerHTML = prob.toFixed(1) + '<span>%</span>';
}

function statusMultiplier(val) { return val; } // Helper

// --- EVENTS ---
// Ball Change -> Update Context Panel
document.querySelectorAll('input[name="ball"]').forEach(r => {
  r.addEventListener('change', (e) => {
    updateContextPanel(e.target.value);
    calculate();
  });
});

// Dropdown & Search (Same as before)
const toggleArrow = document.getElementById('toggle-arrow');
function updateSuggestions(val, force) {
  suggestionsList.innerHTML = '';
  if (!val && !force) { suggestionsList.classList.remove('active'); return; }
  let matches = (!val && force) ? allPokemonNames : allPokemonNames.filter(n => n.startsWith(val.toLowerCase()));
  if (matches.length > 0) {
    suggestionsList.classList.add('active');
    const fragment = document.createDocumentFragment();
    matches.slice(0,100).forEach(match => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${match.charAt(0).toUpperCase() + match.slice(1)}</span>`;
      li.onclick = () => { fetchPokemonData(match); suggestionsList.classList.remove('active'); };
      fragment.appendChild(li);
    });
    suggestionsList.appendChild(fragment);
  } else suggestionsList.classList.remove('active');
}
toggleArrow.addEventListener('click', (e) => { e.stopPropagation(); updateSuggestions(searchInput.value, true); });
searchInput.addEventListener('input', (e) => updateSuggestions(e.target.value));
searchInput.addEventListener('click', (e) => { e.stopPropagation(); if(allPokemonNames.length) updateSuggestions(searchInput.value, true); });
document.addEventListener('click', (e) => { if(!e.target.closest('.search-wrapper')) suggestionsList.classList.remove('active'); });

hpSlider.addEventListener('input', calculate);
document.querySelectorAll('input[name="status"]').forEach(r => r.addEventListener('change', calculate));

// Sim Throw
btnThrow.addEventListener('click', () => {
  const ballImg = document.querySelector('input[name="ball"]:checked').getAttribute('data-img');
  const overlay = document.getElementById('overlay');
  btnThrow.disabled = true; overlay.classList.add('active');
  document.getElementById('anim-content').innerHTML = `
    <div class="pokeball-anim-container"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${ballImg}.png" class="pokeball-anim-img"></div>
    <div style="margin-top:20px; font-weight:600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏¢‡πà‡∏≤...</div>`;
  setTimeout(() => {
    const success = Math.random() * 100 <= window.currentProbability;
    document.getElementById('anim-content').innerHTML = success ? 
      '<div class="msg-success" style="color:#4bc05b; font-size:1.5em; font-weight:bold">‚ú® Gotcha! ‡∏à‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚ú®</div>' : 
      '<div class="msg-fail" style="color:#ff5040; font-size:1.5em; font-weight:bold">üí¢ ‡∏´‡∏•‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ! üí¢</div>';
    setTimeout(() => { overlay.classList.remove('active'); btnThrow.disabled = false; }, 1500);
  }, 2000);
});

</script>
</body>
</html>
